<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>FormInputController</title>
  </head>
  <body>
    <div>
      <form id="guessed-letter-form">
        <input type="text" id="guessed-letter-input" placeholder="" />
      </form>
      start typing letters...<span id="result"></span>
      <hr />
      <p>
       
        This example demonstrates two javascript objects, FormInputController and GameInputController.
        The the later is a subclass of the former (which includes the notion of a timeout between rounds of play.)

        The the two key methods are:

        <ul>
          <li>FormInputController.disableInput()</li>
          <li>FormInputController.enableInput()</li>
        </ul>

        These should be called before and after updating the state of your game within the input listener callback.
        Their purpose is to serialize calls to the event listener in an orderly manner.
        
        The demo does the following:
        <ul>
          <li>accepts single-letter input on a text form</li>
          <li>triggers an event handler</li>
          <li>quiesces the event listener</li>
          <li>processes the input</li>
          <li>triggers a timeout under certain (win/loss) conditions</li>
          <li>re-enables the event listener</li>
          <li>optionally hides and unhides the input form during processing</li>
          <li>optionally restores focus to the input form after unhiding</li>
        </ul>


        The demo accepts 3 characters before kicking off a timeout that simulates then end of a round of play.
        See the console.log for output.
      </p>
    </div>
  </body>

  <script type="text/javascript">
    function FormInputController(inputCallback) {}
    FormInputController.prototype.formId = undefined;
    FormInputController.prototype.inputId = undefined;
    FormInputController.prototype.eventType = "input";
    FormInputController.prototype.hideViewOnDisable = true;
    FormInputController.prototype.reFocusOnUnhide = true;
    FormInputController.prototype.inputCallback = undefined;
    FormInputController.prototype.init = function(
      formId,
      inputId,
      eventType,
      hideViewOnDisable,
      reFocusOnUnhide
    ) {
      this.formId = formId;
      this.inputId = inputId;
      this.eventType = eventType;
      this.hideViewOnDisable = hideViewOnDisable;
      this.reFocusOnUnhide = reFocusOnUnhide;
    };
    FormInputController.prototype.enableInput = function() {
      console.log("fic: enableInput");
      if (this.hideViewOnDisable) {
        this.enableInputView();
      }
      this.enableInputListener(
        this.inputId,
        this.eventType,
        this.inputCallback
      );
    };
    FormInputController.prototype.enableInputView = function() {
      console.log("fic: enableInputView");
      this.inputId.style.visibility = "visible";
      if (this.reFocusOnUnhide) {
        this.inputId.focus();
      }
      this.formId.reset();
    };
    FormInputController.prototype.enableInputListener = function() {
      console.log("fic: enableInputListener");
      this.inputId.addEventListener(this.eventType, this.inputCallback, false);
    };
    FormInputController.prototype.disableInput = function() {
      console.log("fic: disableInput");
      this.disableInputListener(
        this.inputId,
        this.eventType,
        this.inputCallback
      );
      if (this.hideViewOnDisable) {
        this.disableInputView(this.inputId);
      }
    };
    FormInputController.prototype.disableInputView = function() {
      console.log("fic: disableInputView");
      this.inputId.style.visibility = "hidden";
    };
    FormInputController.prototype.disableInputListener = function() {
      console.log("fic: disableInputListener");
      this.inputId.removeEventListener(this.eventType, this.inputCallback);
    };

    function GameInputController() {}
    GameInputController.prototype = new FormInputController();
    GameInputController.prototype.__proto__ = FormInputController.prototype;
    GameInputController.prototype.timeoutCallback = undefined;
    GameInputController.prototype.winTimeoutmSecs = 3000;
    GameInputController.prototype.loseTimeoutmSecs = 6000;
    GameInputController.prototype.init = function(
      formId,
      inputId,
      eventType,
      hideViewOnDisable,
      reFocusOnUnhide,
      winTimeoutmSecs,
      lossTimeoutmSecs
    ) {
      this.formId = formId;
      this.inputId = inputId;
      this.eventType = eventType;
      this.hideViewOnDisable = hideViewOnDisable;
      this.reFocusOnUnhide = reFocusOnUnhide;
      this.winTimeoutmSecs = winTimeoutmSecs;
      this.lossTimeoutmSecs = lossTimeoutmSecs;
    };
    GameInputController.prototype.getTimeoutmSecs = function() {
      return this.timeoutmSecs;
    };
    GameInputController.prototype.setTimeoutmSecs = function(mSecs) {
      this.timeoutmSecs = mSecs;
    };

    function UnitTestGameInputController() {
      gic = new GameInputController();
      let fid = document.getElementById("guessed-letter-form");
      let uid = document.getElementById("guessed-letter-input");
      let eventType = "input";
      let hideViewOnDisable = true;
      let reFocusOnUnhide = true;
      let wTimeoutmSecs = 3000; // msecs timeout
      let lTimeoutmSecs = 5000;
      gic.init(
        fid,
        uid,
        eventType,
        hideViewOnDisable,
        reFocusOnUnhide,
        wTimeoutmSecs,
        lTimeoutmSecs
      );
      gic.inputCallback = getInputCallback(gic);
      gic.timeoutCallback = getTimeoutCallback(gic);

      console.log("UnitTestGameInputController: gic = ", gic);

      let stateCounter = 0;

      gic.enableInputListener();
      gic.inputId.focus();

      function getInputCallback(gic) {
        function innerCallback(e) {
          console.log("innerCallback");
          let uid = this; // 'this' is element owning listener
          gic.disableInput();
          let newState = updateState(e); // update model state
          let sid = document.getElementById("result");
          switch (newState) {
            case "win":
              newState = "reset";
              sid.textContent="you won";
              setTimeout(gic.timeoutCallback, gic.winTimeoutmSecs);
              break;
            case "loss":
              newState = "reset";
              sid.textContent="you lost";
              setTimeout(gic.timeoutCallback, gic.lossTimeoutmSecs);
              break;
            default:
              gic.enableInput();
          }
        }
        return innerCallback;
      }

      function updateState(e) {
        let state = "";
        var ch = e.data.toLowerCase();
        if (ch >= "a" && ch <= "z") {
          console.log("updateState: valid char: ", ch);
          stateCounter++;
          if (stateCounter == 3) {
            stateCounter = 0;
            state = "win";
            console.log(state);
          }
        }
        return state;
      }

      function getTimeoutCallback(gic) {
        function innerCallback() {
          //
          // Update the timeout payload we app-specific logic here.
          //
          console.log("timeout");
          let sid = document.getElementById("result");
          sid.textContent="";
          gic.enableInput();
        }
        return innerCallback;
      }
    }

    UnitTestGameInputController();
  </script>
</html>
